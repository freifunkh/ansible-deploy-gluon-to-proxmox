---

- hosts: mnesia
  vars:
    storage_group: local-hdd
    gluon_image_url: https://hannover.freifunk.net/download/Router-Firmware/Erstinstallation/gluon-ffh-vH21-x86-64.img.gz
  tasks:
    - name: Ensure specified storage_group an zfs volume
      command: 'grep "zfspool: {{storage_group}}" /etc/pve/storage.cfg'
      changed_when: False

    - name: Get the pool of storage_group
      command: "awk '/^zfspool: local-hdd$/ { start=1; } /^\tpool/ { if (start) { print $2; exit 0 } }' /etc/pve/storage.cfg"
      register: zfs_pool_stdout
      changed_when: False

    - name: Store zfs pool in variable zfs_pool
      set_fact:
          zfs_pool: "{{zfs_pool_stdout.stdout_lines[0]}}"

    - name: Create new VM with minimal options
      community.general.proxmox_kvm:
        proxmox_default_behavior: no_defaults
        api_user: ansible-test@pve
        api_password: "{{ proxmox_api_password }}"
        api_host: localhost
        name: fftestnode1
        node: mnesia
        format: raw
        ide:
          ide1: '{{storage_group}}:1,format=raw'
        net:
          net0: 'e1000,bridge=vmbr1'
          net1: 'e1000,bridge=vmbr1'
      register: proxmox_create

    - name: Install Gluon Image
      when: proxmox_create.changed
      block:

        # - name: debug
        #  debug: var=result
        # TASK [debug] ****************************
        # ok: [mnesia] => {
        #     "result": {
        #         "changed": true,
        #         "devices": {
        #             "ide1": "local-hdd:vm-106-disk-0"
        #         },
        #         "failed": false,
        #         "mac": {},
        #         "msg": "VM fftestnode1 with vmid 106 deployed",
        #         "vmid": 106
        #     }
        # }

        - name: Store zfs volume in variable zfs_volume
          set_fact:
            zfs_volume: "{{ proxmox_create.devices.ide1.split(':')[1] }}"

        - name: debug
          debug: var=zfs_volume

        - name: debug
          debug: var=zfs_pool

        - name: Download Router Image
          get_url:
            url: "{{ gluon_image_url }}"
            dest: /tmp/gluon_image.gz

        - name: Unzip to /dev/zvol/{{ zfs_pool}}/{{ zfs_volume}}
          shell: "gunzip /tmp/gluon_image.gz -c | dd iflag=fullblock of=/dev/zvol/{{ zfs_pool}}/{{ zfs_volume}} bs=4M"

    - name: Start VM
      community.general.proxmox_kvm:
        proxmox_default_behavior: no_defaults
        api_user: ansible-test@pve
        api_password: "{{ proxmox_api_password }}"
        api_host: localhost
        name: fftestnode1
        node: mnesia
        state: started
